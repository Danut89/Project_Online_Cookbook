{% extends "base.html" %}
{% block content %}

<section class="container" role="main" aria-label="Recipe Details">

  <!-- ğŸ“¸ Recipe Image -->
  <div class="rounded overflow-hidden mb-4">
    <img src="{{ recipe.image_url or url_for('static', filename='uploads/default_recipe.jpg') }}"
         class="img-fluid w-100" style="max-height: 350px; object-fit: cover;"
         alt="Image of {{ recipe.title }}">
  </div>

  <!-- ğŸ§¾ Recipe Details Card -->
  <div class="card shadow-sm rounded-4 mb-5">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-start flex-wrap">
        <div>
          <h2 class="fw-bold">{{ recipe.title }}</h2>
          <p class="text-muted mb-2">By: <strong>{{ recipe.user.username }}</strong></p>
        </div>
        {% if current_user.is_authenticated and current_user.id != recipe.user_id %}
        <form method="POST" action="{{ url_for('main.like_recipe', recipe_id=recipe.id) }}">
          <button type="submit" class="btn {% if is_liked %}btn-danger{% else %}btn-outline-primary{% endif %} rounded-pill px-4">
            {% if is_liked %}â¤ï¸ Unlike{% else %}ğŸ¤ Like{% endif %}
          </button>
        </form>
        {% endif %}
      </div>

      <hr>

      <!-- ğŸ§… Tabbed Details (Ingredients / Steps / Info) -->
      <ul class="nav nav-pills mb-3" id="recipeTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="ingredients-tab" data-bs-toggle="pill" data-bs-target="#ingredients"
                  type="button" role="tab">ğŸ¥¦ Ingredients</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="steps-tab" data-bs-toggle="pill" data-bs-target="#steps"
                  type="button" role="tab">ğŸ‘¨â€ğŸ³ Steps</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="info-tab" data-bs-toggle="pill" data-bs-target="#info"
                  type="button" role="tab">â„¹ï¸ Info</button>
        </li>
      </ul>

      <div class="tab-content" id="recipeTabContent">
        <div class="tab-pane fade show active" id="ingredients" role="tabpanel">
          <pre class="bg-light p-3 rounded-3">{{ recipe.ingredients }}</pre>
        </div>
        <div class="tab-pane fade" id="steps" role="tabpanel">
          <pre class="bg-light p-3 rounded-3">{{ recipe.steps }}</pre>
        </div>
        <div class="tab-pane fade" id="info" role="tabpanel">
          <p class="mt-3"><strong>Description:</strong> {{ recipe.description }}</p>
          <p><strong>Cuisine:</strong> {{ recipe.cuisine }}</p>
          <p><strong>Prep Time:</strong> {{ recipe.prep_time }} minutes</p>
          <p><strong>Difficulty:</strong>
            <span class="badge bg-warning text-dark">{{ recipe.difficulty }}</span>
          </p>
          {% if recipe.categories %}
            <p><strong>Categories:</strong>
              {% for cat in recipe.categories %}
                <span class="badge bg-info text-dark me-1">{{ cat.name }}</span>
              {% endfor %}
            </p>
          {% endif %}
        </div>
      </div>

      <!-- âœï¸ Edit/Delete Buttons (Owner Only) -->
        {% if current_user.id == recipe.user_id %}
            <div class="d-flex gap-2 mt-3">
                <a href="{{ url_for('main.edit_recipe', recipe_id=recipe.id, next=request.full_path) }}"
                class="btn btn-warning fw-semibold">Edit Recipe</a>

                <form method="POST" action="{{ url_for('main.delete_recipe', recipe_id=recipe.id) }}"
                    onsubmit="return confirm('Are you sure you want to delete this recipe?');">
                <button type="submit" class="btn btn-danger fw-semibold">Delete</button>
                </form>
            </div>
        {% endif %}

    </div>
  </div>
</section>

<!-- ğŸ’¬ Comments Section -->
<section class="container mb-5" aria-labelledby="comments-heading">
  <h4 id="comments-heading" class="mb-3">ğŸ’¬ Comments</h4>

  {% if comments %}
    <ul class="list-group mb-4">
      {% for comment in comments %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
          </div>
          <div>{{ comment.content }}</div>
          {% if current_user.id == comment.user_id %}
            <form method="POST" action="{{ url_for('main.delete_comment', comment_id=comment.id) }}"
                  onsubmit="return confirm('Delete this comment?');" class="mt-1 text-end">
              <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-info">No comments yet. Be the first to comment!</div>
  {% endif %}

  {% if current_user.is_authenticated %}
    <form method="POST" class="bg-white p-4 shadow-sm rounded-4">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.content.label(class="form-label") }}
        {{ form.content(class="form-control", rows="3", placeholder="Write something...") }}
      </div>
      {{ form.submit(class="btn btn-primary px-4 rounded-pill fw-semibold") }}
    </form>
  {% else %}
    <p><a href="{{ url_for('auth.login') }}">Log in</a> to leave a comment.</p>
  {% endif %}
</section>

<div class="text-center mb-5">
  <a href="{{ url_for('main.home') }}" class="btn btn-secondary rounded-pill px-4">â† Back to Home</a>
</div>

{% endblock %}
